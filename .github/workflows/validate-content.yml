name: ðŸ” ValidaÃ§Ã£o de ConteÃºdo

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  validate-markdown-links:
    name: âœ… Links em Markdown
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Validar links em arquivos Markdown
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          config-file: '.github/workflows/markdown-link-check.config.json'
          folder-path: 'modulo6_repo/'
          file-extension: '.md'
          check-modified-files-only: 'no'

  validate-html:
    name: âœ… ValidaÃ§Ã£o HTML (W3C)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar html-validate
        run: npm install -g html-validate

      - name: Validar arquivos HTML
        run: |
          echo "ðŸ” Validando arquivos HTML..."
          find modulo6_repo/assets/html -name "*.html" -type f | while read file; do
            echo "Validando: $file"
            html-validate "$file" || exit 1
          done

  validate-workload:
    name: âœ… Carga HorÃ¡ria (30h)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Validar carga horÃ¡ria total
        run: |
          echo "ðŸ• Verificando carga horÃ¡ria do mÃ³dulo..."
          
          # Procurar por padrÃµes de duraÃ§Ã£o no PTD
          PTD_FILE="modulo6_repo/docs/curso/modulo6_ptd_30h.md"
          
          if [ ! -f "$PTD_FILE" ]; then
            echo "âŒ Arquivo PTD nÃ£o encontrado: $PTD_FILE"
            exit 1
          fi
          
          # Extrair duraÃ§Ãµes e somar (formato: XXmin ou XXh)
          TOTAL_MIN=$(grep -oP '\d+min|\d+h' "$PTD_FILE" | \
            awk '{
              if ($0 ~ /min/) {
                gsub(/min/, "", $0);
                total += $0;
              } else if ($0 ~ /h/) {
                gsub(/h/, "", $0);
                total += $0 * 60;
              }
            } END { print total }')
          
          TOTAL_HOURS=$(echo "scale=1; $TOTAL_MIN / 60" | bc)
          
          echo "ðŸ“Š Carga horÃ¡ria calculada: ${TOTAL_HOURS}h (${TOTAL_MIN}min)"
          
          # Verificar se estÃ¡ prÃ³ximo de 30h (permitir variaÃ§Ã£o de Â±1h)
          if (( $(echo "$TOTAL_HOURS >= 29 && $TOTAL_HOURS <= 31" | bc -l) )); then
            echo "âœ… Carga horÃ¡ria dentro do esperado (29-31h)"
          else
            echo "âš ï¸ Aviso: Carga horÃ¡ria fora do range esperado"
            echo "   Esperado: ~30h | Calculado: ${TOTAL_HOURS}h"
            # NÃ£o falhar o build, apenas avisar
          fi

  validate-terminology:
    name: âœ… ConsistÃªncia de Terminologia
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Verificar consistÃªncia de termos tÃ©cnicos
        run: |
          echo "ðŸ“ Verificando consistÃªncia de terminologia..."
          
          # Termos que devem estar em inglÃªs (padrÃ£o da indÃºstria)
          ENGLISH_TERMS=(
            "Data Engineer"
            "Data Scientist"
            "Data Analyst"
            "Machine Learning"
            "Deep Learning"
            "Data Pipeline"
            "ETL"
            "Data Warehouse"
            "Data Lake"
            "Business Intelligence"
          )
          
          # Termos que podem estar errados (traduÃ§Ãµes inadequadas)
          WRONG_TERMS=(
            "Engenheiro de Dados:Data Engineer"
            "Cientista de Dados:Data Scientist"
            "Analista de Dados:Data Analyst"
            "Aprendizado de MÃ¡quina:Machine Learning"
            "ArmazÃ©m de Dados:Data Warehouse"
            "Lago de Dados:Data Lake"
            "InteligÃªncia de NegÃ³cios:Business Intelligence"
          )
          
          ISSUES_FOUND=0
          
          for term_pair in "${WRONG_TERMS[@]}"; do
            WRONG=$(echo $term_pair | cut -d':' -f1)
            CORRECT=$(echo $term_pair | cut -d':' -f2)
            
            if grep -r "$WRONG" modulo6_repo/docs --include="*.md" -q; then
              echo "âš ï¸ Termo inadequado encontrado: '$WRONG' (use '$CORRECT')"
              ISSUES_FOUND=$((ISSUES_FOUND + 1))
            fi
          done
          
          if [ $ISSUES_FOUND -eq 0 ]; then
            echo "âœ… Terminologia consistente!"
          else
            echo "âš ï¸ Encontrados $ISSUES_FOUND avisos de terminologia"
            echo "   (NÃ£o bloqueia o build, mas considere revisar)"
          fi

  summary:
    name: ðŸ“Š Resumo da ValidaÃ§Ã£o
    runs-on: ubuntu-latest
    needs: [validate-markdown-links, validate-html, validate-workload, validate-terminology]
    if: always()
    steps:
      - name: Resumo de resultados
        run: |
          echo "## ðŸ“‹ Resumo da ValidaÃ§Ã£o de ConteÃºdo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Todas as validaÃ§Ãµes foram executadas" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ValidaÃ§Ãµes Realizadas:" >> $GITHUB_STEP_SUMMARY
          echo "- Links em Markdown" >> $GITHUB_STEP_SUMMARY
          echo "- ValidaÃ§Ã£o HTML (W3C)" >> $GITHUB_STEP_SUMMARY
          echo "- Carga HorÃ¡ria Total (30h)" >> $GITHUB_STEP_SUMMARY
          echo "- ConsistÃªncia de Terminologia" >> $GITHUB_STEP_SUMMARY
